<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Keuangan</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

    <style>
        /* (CSS tidak berubah) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-nav { display: flex; justify-content: space-between; align-items: center; }
        .back-link { text-decoration: none; background-color: #6c757d; color: white; padding: 8px 12px; border-radius: 5px; }
        #editor-spreadsheet { width: 100%; height: 400px; overflow: hidden; margin-top: 15px; }
        button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 15px; }
        button:hover { background-color: #218838; }
        #status-simpan { margin-top: 10px; color: green; font-style: italic; }
        .summary { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fafafa; }
        .summary h3 { margin-top: 0; }
        .summary-item { display: flex; justify-content: space-between; padding: 8px 0; font-size: 1.1em; }
        .summary-item:not(:last-child) { border-bottom: 1px solid #eee; }
        .summary-item span:first-child { font-weight: bold; }
        .pemasukan { color: #28a745; }
        .pengeluaran { color: #dc3545; }
        .sisa { color: #17a2b8; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-nav">
            <h1 id="file-title">Memuat...</h1>
            <a href="index.html" class="back-link">‚Üê Kembali ke Daftar File</a>
        </div>
        <div id="editor-spreadsheet"></div>
        <div id="error-message" style="color: red; font-weight: bold; margin-top: 10px;"></div>

        <button id="simpan-data" style="display:none;">üíæ Simpan Data ke Cloud</button>
        <div id="status-simpan"></div>
        <a id="view-public-link" href="#" target="_blank" style="display:none; margin-left: 15px; text-decoration: none; background-color: #17a2b8; color: white; padding: 10px 15px; border-radius: 5px; font-size: 16px;">Lihat Versi Publik</a>
        
        <div class="summary" style="display:none;">
            <h3>Ringkasn Keuangan</h3>
            <div class="summary-item"><span>Total Pemasukan</span><span id="total-pemasukan" class="pemasukan">Rp 0</span></div>
            <div class="summary-item"><span>Total Pengeluaran</span><span id="total-pengeluaran" class="pengeluaran">Rp 0</span></div>
            <hr>
            <div class="summary-item"><span>Sisa Saldo</span><span id="sisa-saldo" class="sisa">Rp 0</span></div>
        </div>
    </div>

    <script>
    // SEMUA KODE SEKARANG BERADA DI DALAM SATU WADAH INI
    document.addEventListener('DOMContentLoaded', async function() {
        // --- (Fungsi-fungsi pembantu tetap sama) ---
        function formatRupiah(a){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(a)}
        function updateSummary(a){let e=0,t=0;a.forEach(a=>{if(a&&a[2]&&parseFloat(a[3])){const n=a[2],s=parseFloat(a[3]);"Pemasukan"===n?e+=s:"Pengeluaran"===n&&(t+=s)}});const n=e-t;document.getElementById("total-pemasukan").textContent=formatRupiah(e);document.getElementById("total-pengeluaran").textContent=formatRupiah(t);document.getElementById("sisa-saldo").textContent=formatRupiah(n)}

        const APP_STORAGE_KEY = 'financialAppFiles_Cloud';
        const JSONBIN_API_KEY = '$2a$10$j2Nyj9TkaoCxOxe/PKYBtugSiQQXoaM3gIEzZm0cAjA3ibx7cyDdi'; // API Key Anda
        
        const container = document.getElementById('editor-spreadsheet');
        const saveButton = document.getElementById('simpan-data');
        const fileTitleEl = document.getElementById('file-title');
        const errorEl = document.getElementById('error-message');
        const summaryEl = document.querySelector('.summary');
        const viewLink = document.getElementById('view-public-link');

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const localId = urlParams.get('localId');

            if (!localId) {
                throw new Error("ID File Lokal tidak ditemukan di URL. Silakan kembali ke halaman utama dan klik 'Edit'.");
            }
            
            const localManifestJSON = localStorage.getItem(APP_STORAGE_KEY);
            if (!localManifestJSON) {
                throw new Error("Manifest file tidak ditemukan di browser ini. Mungkin data browser terhapus atau Anda menggunakan browser yang berbeda.");
            }
            const localManifest = JSON.parse(localManifestJSON);

            const currentFile = localManifest[localId];
            if (!currentFile) {
                throw new Error(`File dengan ID lokal '${localId}' tidak ditemukan dalam manifest.`);
            }
            
            const BIN_ID = currentFile.binId;
            if (!BIN_ID) {
                throw new Error("Bin ID tidak ditemukan untuk file ini di dalam manifest lokal.");
            }
            
            fileTitleEl.textContent = `Memuat data untuk: ${currentFile.title}...`;

            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_API_KEY }
            });

            if (!response.ok) {
                throw new Error(`Gagal mengambil data dari server. Status: ${response.status} ${response.statusText}`);
            }

            const cloudData = await response.json();
            
            // PERBAIKAN KRUSIAL: Menggunakan cloudData.record
            fileTitleEl.textContent = `üìù Editor: ${cloudData.record.title}`;

            const hot = new Handsontable(container, {
                data: cloudData.record.data, // PERBAIKAN KRUSIAL
                startRows: 5, colHeaders: ['Tanggal', 'Deskripsi', 'Tipe', 'Jumlah'],
                columns: [{ type: 'date', dateFormat: 'DD/MM/YYYY' }, { type: 'text' }, { type: 'dropdown', source: ['Pemasukan', 'Pengeluaran'] }, { type: 'numeric', numericFormat: { pattern: '0,0' } }],
                colWidths: [120, 300, 120, 150], rowHeaders: true, contextMenu: true, minSpareRows: 1, licenseKey: 'non-commercial-and-evaluation',
                afterChange: function() { updateSummary(this.getData()); },
                afterRemoveRow: function() { updateSummary(this.getData()); }
            });

            // Tampilkan elemen yang disembunyikan
            saveButton.style.display = 'inline-block';
            summaryEl.style.display = 'block';
            
            // PERBAIKAN PENEMPATAN KODE: Link viewer diatur setelah semua berhasil dimuat
            viewLink.href = `viewer.html?binId=${BIN_ID}`;
            viewLink.style.display = 'inline-block';
            
            updateSummary(hot.getData());

            saveButton.addEventListener('click', async function() {
                saveButton.disabled = true;
                saveButton.textContent = 'Menyimpan...';
                
                const tableData = hot.getData();
                const cleanData = tableData.filter(row => !row.every(cell => cell === null || cell === ''));
                
                const payload = { title: cloudData.record.title, data: cleanData }; // PERBAIKAN KRUSIAL

                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_API_KEY },
                    body: JSON.stringify(payload)
                });
                
                document.getElementById('status-simpan').textContent = `Data berhasil disimpan ke cloud!`;
                saveButton.disabled = false;
                saveButton.textContent = 'üíæ Simpan Data ke Cloud';
            });

        } catch (error) {
            console.error("ERROR FATAL:", error);
            errorEl.textContent = `Terjadi Kesalahan: ${error.message}`;
            fileTitleEl.textContent = 'Gagal Memuat';
        }
    });
    </script>
</body>
</html>
