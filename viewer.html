<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katalog Data Keuangan</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

    <style>
        /* (CSS tidak berubah) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .file-selector { margin-bottom: 20px; padding: 15px; background-color: #e9ecef; border-radius: 5px; }
        .file-selector label { font-weight: bold; margin-right: 10px; }
        .file-selector select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; min-width: 300px; font-size: 1em; }
        #viewer-spreadsheet { width: 100%; height: 400px; overflow: hidden; margin-top: 15px; }
        #placeholder-message { padding: 40px; text-align: center; color: #6c757d; background-color: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 5px; }
        .summary { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fafafa; }
        .summary h3 { margin-top: 0; }
        .summary-item { display: flex; justify-content: space-between; padding: 8px 0; font-size: 1.1em; }
        .pemasukan { color: #28a745; }
        .pengeluaran { color: #dc3545; }
        .sisa { color: #17a2b8; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“š Katalog Data Keuangan (Publik)</h1>
        
        <div class="file-selector">
            <label for="file-dropdown">Pilih File untuk Dilihat:</label>
            <select id="file-dropdown">
                <option value="">-- Harap Pilih File --</option>
            </select>
        </div>
        
        <h2 id="file-title" style="display:none;"></h2>
        <div id="viewer-spreadsheet"></div>
        <div id="placeholder-message">
            <p>Silakan pilih file dari menu di atas untuk menampilkan datanya.</p>
        </div>
        
        <div id="summary-container" class="summary" style="display:none;"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropdown = document.getElementById('file-dropdown');
        const fileTitleEl = document.getElementById('file-title');
        const container = document.getElementById('viewer-spreadsheet');
        const placeholder = document.getElementById('placeholder-message');
        const summaryContainer = document.getElementById('summary-container');
        
        const APP_STORAGE_KEY = 'financialAppFiles_Cloud';

        function formatRupiah(a){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(a)}
        function renderSummary(data) {
            let pemasukan = 0, pengeluaran = 0;
            data.forEach(row => {
                if (row && row[2] && parseFloat(row[3])) {
                    if (row[2] === 'Pemasukan') pemasukan += parseFloat(row[3]);
                    if (row[2] === 'Pengeluaran') pengeluaran += parseFloat(row[3]);
                }
            });
            summaryContainer.style.display = 'block';
            summaryContainer.innerHTML = `<h3>Ringkasan Keuangan</h3><div class=summary-item><span>Total Pemasukan</span><span class="pemasukan">${formatRupiah(pemasukan)}</span></div><div class=summary-item><span>Total Pengeluaran</span><span class="pengeluaran">${formatRupiah(pengeluaran)}</span></div><hr><div class=summary-item><span>Sisa Saldo</span><span class="sisa">${formatRupiah(pemasukan - pengeluaran)}</span></div>`;
        }
        
        async function loadAndDisplayBinData(binId) {
            if (!binId) {
                // Sembunyikan semua tampilan data jika tidak ada file yang dipilih
                placeholder.style.display = 'block';
                placeholder.innerHTML = '<p>Silakan pilih file dari menu di atas untuk menampilkan datanya.</p>';
                container.style.display = 'none';
                summaryContainer.style.display = 'none';
                fileTitleEl.style.display = 'none';
                return;
            }
            
            placeholder.style.display = 'block';
            container.style.display = 'none';
            summaryContainer.style.display = 'none';
            placeholder.innerHTML = '<p>Memuat data dari cloud...</p>';

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`);
                if (!response.ok) throw new Error('Data tidak ditemukan atau bersifat privat.');
                
                const result = await response.json();
                
                // PERBAIKAN KRUSIAL: Gunakan result.record
                const record = result.record;
                
                placeholder.style.display = 'none';
                container.style.display = 'block';
                fileTitleEl.style.display = 'block';
                fileTitleEl.textContent = `ðŸ“Š Menampilkan: ${record.title}`;

                container.innerHTML = '';
                new Handsontable(container, {
                    data: record.data, // PERBAIKAN KRUSIAL
                    readOnly: true,
                    rowHeaders: true, colHeaders: ['Tanggal', 'Deskripsi', 'Tipe', 'Jumlah'],
                    columns: [{ type: 'date', dateFormat: 'DD/MM/YYYY' }, {}, {}, { type: 'numeric', numericFormat: { pattern: '0,0' } }],
                    licenseKey: 'non-commercial-and-evaluation'
                });
                
                renderSummary(record.data); // PERBAIKAN KRUSIAL

            } catch(error) {
                placeholder.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
            }
        }

        function initializeViewer() {
            const localManifest = JSON.parse(localStorage.getItem(APP_STORAGE_KEY) || '{}');
            const fileIds = Object.keys(localManifest);

            if (fileIds.length === 0) {
                dropdown.disabled = true;
                placeholder.innerHTML = '<p>Tidak ada file yang ditemukan di browser ini. Harap buat file terlebih dahulu menggunakan halaman `index.html`.</p>';
                return;
            }
            
            fileIds.forEach(id => {
                const file = localManifest[id];
                const option = document.createElement('option');
                option.value = file.binId;
                option.textContent = file.title;
                dropdown.appendChild(option);
            });

            dropdown.addEventListener('change', (event) => {
                const selectedBinId = event.target.value;
                loadAndDisplayBinData(selectedBinId);
            });

            const urlParams = new URLSearchParams(window.location.search);
            const binIdFromUrl = urlParams.get('binId');
            if (binIdFromUrl) {
                dropdown.value = binIdFromUrl;
                loadAndDisplayBinData(binIdFromUrl);
            }
        }
        
        initializeViewer();
    });
    </script>
</body>
</html>
